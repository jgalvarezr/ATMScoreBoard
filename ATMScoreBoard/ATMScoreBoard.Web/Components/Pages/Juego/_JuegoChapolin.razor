@using ATMScoreBoard.Shared
@using ATMScoreBoard.Shared.Models
@using ATMScoreBoard.Web.DTOs
@using System.Net.Http.Json
@using ATMScoreBoard.Web.Services

@inject PartidaService PartidaService
@inject IJSRuntime JSRuntime

<div id="scoring-area">

    <div class="row">
        <!-- Botones Equipo A -->
        <div class="col-4 col-xxl-3">
            <div class="flex-5-cols">
                @for (int i = 1; i <= 16; i++)
                {
                    int bola = (i > 15) ? 0 : i;
                    string cssClass = classBola(bola);
                    bool isDisabled = cssClass == "bola-atenuada";

                    <div>
                        <button class="btn btn-dark p-0 btn-bola @cssClass"
                                disabled="@isDisabled"
                                @onclick="() => AnotarBola(equipoIdL, bola)">
                            <img src="/images/bola-@(bola.ToString("D2")).png" class="img-fluid" />
                        </button>
                    </div>
                }
            </div>
        </div>

        <div class="col-4 col-xxl-6 text-center">
            <button class="btn btn-outline-secondary btn-sm" @onclick="IntercambiarLados">
                <i class="bi bi-arrow-left-right"></i> Intercambiar Bandas
            </button>
        </div>

        <!-- Botones Equipo B -->
        <div class="col-4 col-xxl-3">
            <div class=" flex-5-cols ">
                @for (int i = 1; i <= 16; i++)
                {
                    int bola = (i > 15) ? 0 : i;
                    string cssClass = classBola(bola);
                    bool isDisabled = cssClass == "bola-atenuada";

                    <div>
                        <button class="btn btn-dark p-0 btn-bola @cssClass"
                                disabled="@isDisabled"
                                @onclick="() => AnotarBola(equipoIdR, bola)">
                            <img src="/images/bola-@(bola.ToString("D2")).png" class="img-fluid" />
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [CascadingParameter]
    public PartidaActual? partidaActual { get; set; }

    [Parameter] public EventCallback OnEstadoJuegoCambiado { get; set; }
    [Parameter] public List<int> bolasA { get; set; } = new();
    [Parameter] public List<int> bolasB { get; set; } = new();
    [Parameter] public bool EnModoCorreccion { get; set; }

    private int equipoIdL;
    private int equipoIdR;

    protected override void OnParametersSet()
    {
        if (partidaActual != null)
        {
            // LÓGICA:
            // Izquierda (L) = Banda Roja
            // Derecha (R) = Banda Blanca

            // Si BandaEquipoA es "Roja", A está en la Izquierda (L).
            bool equipoA_EsRoja = string.IsNullOrEmpty(partidaActual.BandaEquipoA) || partidaActual.BandaEquipoA == "Roja";

            if (equipoA_EsRoja)
            {
                // CASO 1: A es Izquierda (L), B es Derecha (R)
                equipoIdL = partidaActual.EquipoAId;               
                equipoIdR = partidaActual.EquipoBId;                
            }
            else
            {
                // CASO 2: A es Derecha (R), B es Izquierda (L)
                equipoIdL = partidaActual.EquipoBId;                
                equipoIdR = partidaActual.EquipoAId;                
            }
        }
    }

    private async Task IntercambiarLados()
    {
        if (partidaActual == null) return;

        var accion = new AccionJuegoDto
        {
            MesaId = partidaActual.MesaId,
            TipoAccion = "IntercambiarBandas", // Esta acción ya la creamos en el servicio
            Payload = default
        };

        try
        {
            await PartidaService.RealizarAccionAsync(accion);
            await OnEstadoJuegoCambiado.InvokeAsync();
            
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", ex.Message, "error");
        }
    }


    private async Task AnotarBola(int equipoId, int numeroBola)
    {

      

        if (partidaActual == null) return;

        string tipoAccion = EnModoCorreccion ? "CorregirBola"  : "EmbolsarBola";

        var accion = new AccionJuegoDto
        {
            MesaId = partidaActual.MesaId,
            TipoAccion = tipoAccion,
            Payload =  System.Text.Json.JsonDocument.Parse(System.Text.Json.JsonSerializer.Serialize(new 
            {
                EquipoId = equipoId,
                NumeroBola = numeroBola
            })).RootElement
        };

        try
        {
            // LLAMADA DIRECTA AL SERVICIO
            await PartidaService.RealizarAccionAsync(accion);

            // Si tiene éxito, notificamos al padre para que refresque
            await OnEstadoJuegoCambiado.InvokeAsync();
        }
        catch (Exception ex)
        {
            // Manejar el error (por ejemplo, con un SweetAlert)
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Acción Inválida", ex.Message, "error");
        }
    }

    private String classBola(int bola)
    {
        if (!EnModoCorreccion)
            return  bolasA.Contains(bola) || bolasB.Contains(bola) ? "bola-atenuada" : "";
        else
            return bolasA.Contains(bola) || bolasB.Contains(bola) ? "" : "bola-atenuada";
       
    }

}