@page "/juego/{MesaId:int}"
@using ATMScoreBoard.Shared
@using ATMScoreBoard.Shared.Models
@using Microsoft.EntityFrameworkCore
@using ATMScoreBoard.Web.Components.Pages.Juego
@using ATMScoreBoard.Web.Services

@inject NavigationManager Navigation
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject PartidaService PartidaService

<PageTitle>Partida - Mesa @MesaId</PageTitle>

@if (isLoading)
{
    <p><em>Cargando partida...</em></p>
}
else if (partidaActual == null || errorMessage != null)
{
    <div class="alert alert-danger">
        <h4 class="alert-heading">Error al Cargar la Partida</h4>
        <p>@errorMessage</p>
        <hr>
        <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/")'>Volver al Dashboard</button>
    </div>
}
else
{
    <!-- Este es el contenedor principal del juego -->
    <!-- Pasamos 'partidaActual' a todos los componentes hijos usando CascadingValue -->
    <CascadingValue Value="partidaActual">

        <_EncabezadoMarcador nombreEquipoA="@GetNombresFromNavigation(partidaActual.EquipoA)"
                             nombreEquipoB="@GetNombresFromNavigation(partidaActual.EquipoB)"
                             tipoJuegoNombre="@(((TipoJuego)partidaActual.TipoJuegoId).ToString())"
                             puntuacionA="puntuacionA"
                             puntuacionB="puntuacionB"
                             bolasA="bolasA"
                             bolasB="bolasB"
                             Ganador="resultadoJuego.Ganador" />



        <!-- 2. BODY (Switch para la modalidad de juego) -->
        @switch ((TipoJuego)partidaActual.TipoJuegoId)
        {
            case TipoJuego.Chapolin:
                <!-- <JuegoChapolin /> -->
                <_JuegoChapolin OnEstadoJuegoCambiado="EstadoCambiado"
                                bolasA="bolasA"
                                bolasB="bolasB"
                                EnModoCorreccion="EnModoCorreccion" />
                break;
            case TipoJuego.Bola8:
                <!-- <JuegoBola8 /> -->
                <_JuegoBola8 OnEstadoJuegoCambiado="EstadoCambiado"
                             bolasA="bolasA"
                             bolasB="bolasB"
                             EnModoCorreccion="EnModoCorreccion" />
                break;
            default:
                <div class="alert alert-warning">Esta modalidad de juego aún no está implementada.</div>
                break;
        }

        <hr class="my-2" />

        <!-- 3. FOOTER (futuro componente _AccionesPartida) -->
        <div>
            <_AccionesPartida PuntuacionA="puntuacionA"
                              PuntuacionB="puntuacionB"
                              OnModoCorreccionChange="ActivarModoCorreccion"
                              ResultadoJuego="resultadoJuego" />
        </div>

    </CascadingValue>
}

@code {
    [Parameter]
    public int MesaId { get; set; }

    private PartidaActual? partidaActual;
    private bool isLoading = true;
    private string? errorMessage;

    private int puntuacionA = 0;
    private int puntuacionB = 0;
    private List<int> bolasA = new();
    private List<int> bolasB = new();
    public string nombreEquipoA { get; set; } = "";
    public string nombreEquipoB { get; set; } = "";
    public string tipoJuegoNombre { get; set; } = "";

    public bool EnModoCorreccion { get; private set; } = false;
    private ResultadoChequeo resultadoJuego = new();


    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var context = DbContextFactory.CreateDbContext();

            // Cargamos la partida actual y la información de los equipos
            partidaActual = await context.PartidasActuales
                .Include(p => p.EquipoA)
                .ThenInclude(e => e.EquipoJugadores)
                .ThenInclude(ej => ej.Jugador)
                .Include(p => p.EquipoB)
                .ThenInclude(e => e.EquipoJugadores)
                .ThenInclude(ej => ej.Jugador)
                .FirstOrDefaultAsync(p => p.MesaId == MesaId);


            if (partidaActual != null)
            {
                nombreEquipoA = GetNombresFromNavigation(partidaActual.EquipoA);
                nombreEquipoB = GetNombresFromNavigation(partidaActual.EquipoB);
                tipoJuegoNombre = ((TipoJuego)partidaActual.TipoJuegoId).ToString();

                await CargarEstadoJuego();

            }
            else
            {
                errorMessage = $"No se encontró una partida en curso para la mesa {MesaId}.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar la partida: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task EstadoCambiado()
    {
        await CargarEstadoJuego();
        StateHasChanged();
    }

    private async Task CargarEstadoJuego()
    {
        if (partidaActual == null) return;

        using var context = DbContextFactory.CreateDbContext();

        var bolasGuardadas = await context.PartidasActualesBolas
                                        .Where(b => b.MesaId == partidaActual.MesaId)
                                        .OrderBy(b => b.Timestamp)
                                        .ToListAsync();

        // Limpiamos el estado local antes de recalcular
        puntuacionA = 0;
        puntuacionB = 0;
        bolasA.Clear();
        bolasB.Clear();


        foreach (var bola in bolasGuardadas)
        {
            int puntos = 0;

            switch (partidaActual.TipoJuegoId)
            {
                case 1:
                    if (bola.EquipoId == partidaActual.EquipoAId)
                    {
                        puntuacionA += 1;
                        bolasA.Add(bola.NumeroBola);
                    }
                    else if (bola.EquipoId == partidaActual.EquipoBId)
                    {
                        puntuacionB += 1;
                        bolasB.Add(bola.NumeroBola);
                    } 
                    else if (bola.EquipoId == null)
                    {
                        puntuacionA += 1;
                        puntuacionB += 1;
                        bolasA.Add(bola.NumeroBola);
                        bolasB.Add(bola.NumeroBola);
                    }
                    break;

                case 4:
                    puntos = bola.NumeroBola == 0 ? 10 : bola.NumeroBola;
                    if (bola.EquipoId == partidaActual.EquipoAId)
                    {
                        puntuacionA += puntos;
                        bolasA.Add(bola.NumeroBola);
                    }
                    else if (bola.EquipoId == partidaActual.EquipoBId)
                    {
                        puntuacionB += puntos;
                        bolasB.Add(bola.NumeroBola);
                    }
                    break;
            }

            resultadoJuego = await PartidaService.ChequearEstadoPartidaAsync(partidaActual.MesaId);
            await PartidaService.NotificarCambioDeEstado(partidaActual.MesaId);
        }
    }

    private string GetNombresFromNavigation(Equipo equipo)
    {
        // Usamos las propiedades de navegación que ya cargamos en el componente padre
        var nombres = equipo.EquipoJugadores.Select(ej => ej.Jugador.Nombre).ToList();
        return string.Join("<br />", nombres);
    }

    public void ActivarModoCorreccion(bool activar)
    {
        EnModoCorreccion = activar;
        StateHasChanged(); // Forzamos a que la UI se re-renderice
    }
}
